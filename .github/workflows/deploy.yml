# ==============================================================================
#                 GitHub Actions Workflow for Deploying to GitHub Pages
# ==============================================================================
#
# å·¥ä½œæµç¨‹åç¨±:
#   é¡¯ç¤ºåœ¨ GitHub Actions é é¢ä¸Šçš„åç¨±
name: Deploy to GitHub Pages

# è§¸ç™¼æ¢ä»¶ (Triggers):
#   - ç•¶æœ‰ç¨‹å¼ç¢¼è¢«æ¨é€åˆ° `main` åˆ†æ”¯æ™‚ï¼Œæ­¤å·¥ä½œæµç¨‹æœƒè‡ªå‹•åŸ·è¡Œã€‚
#   - `workflow_dispatch` å…è¨±ä½ æ‰‹å‹•å¾ Actions é é¢è§¸ç™¼æ­¤å·¥ä½œæµç¨‹ã€‚
on:
  push:
    branches:
      - main
  workflow_dispatch:

# æ¬Šé™è¨­å®š (Permissions):
#   é€™æ˜¯éƒ¨ç½²åˆ° GitHub Pages æ‰€éœ€çš„æ¨™æº–æ¬Šé™è¨­å®šã€‚
permissions:
  contents: read
  pages: write
  id-token: write

# ç’°å¢ƒè¨­å®š (Environment):
#   è¨­å®šéƒ¨ç½²çš„ç’°å¢ƒï¼ŒæŒ‡å‘ GitHub Pagesã€‚
#   `url: ${{ steps.deployment.outputs.page_url }}` æœƒåœ¨å®Œæˆå¾Œé¡¯ç¤ºç¶²ç«™çš„ URLã€‚
environment:
  name: github-pages
  url: ${{ steps.deployment.outputs.page_url }}

# å·¥ä½œ (Jobs):
#   å®šç¾©å·¥ä½œæµç¨‹ä¸­è¦åŸ·è¡Œçš„ä»»å‹™ã€‚
jobs:
  deploy:
    # åŸ·è¡Œç’°å¢ƒ:
    #   ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Ubuntu ä½œç‚ºåŸ·è¡Œç’°å¢ƒã€‚
    runs-on: ubuntu-latest

    # æ­¥é©Ÿ (Steps):
    #   å®šç¾©æ­¤å·¥ä½œä¸­è¦ä¾åºåŸ·è¡Œçš„æ­¥é©Ÿã€‚
    steps:
      # æ­¥é©Ÿ 1: ç°½å‡ºç¨‹å¼ç¢¼
      #   ä½¿ç”¨å®˜æ–¹çš„ `checkout` action ä¾†å–å¾—ä½ çš„å€‰åº«ç¨‹å¼ç¢¼ã€‚
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: å¾ Secrets å»ºç«‹ Firebase è¨­å®šæª”
      #   é€™æ˜¯è§£æ±ºå•é¡Œçš„æ ¸å¿ƒæ­¥é©Ÿã€‚
      #   å®ƒæœƒè¤‡è£½ç¯„æœ¬æª”ï¼Œä¸¦ä½¿ç”¨ `sed` æŒ‡ä»¤å°‡ç¯„æœ¬ä¸­çš„ä½”ä½ç¬¦ (__API_KEY__, etc.)
      #   æ›¿æ›æˆä½ åœ¨ GitHub Secrets ä¸­å„²å­˜çš„çœŸå¯¦é‡‘é‘°ã€‚
      - name: Create Firebase Config from Secrets
        run: |
          echo "ğŸš€ Generating firebase-config.js from template..."
          cp firebase-config.template.js firebase-config.js
          
          sed -i 's|__API_KEY__|${{ secrets.FIREBASE_API_KEY }}|g' firebase-config.js
          sed -i 's|__AUTH_DOMAIN__|${{ secrets.FIREBASE_AUTH_DOMAIN }}|g' firebase-config.js
          sed -i 's|__PROJECT_ID__|${{ secrets.FIREBASE_PROJECT_ID }}|g' firebase-config.js
          sed -i 's|__STORAGE_BUCKET__|${{ secrets.FIREBASE_STORAGE_BUCKET }}|g' firebase-config.js
          sed -i 's|__SENDER_ID__|${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}|g' firebase-config.js
          sed -i 's|__APP_ID__|${{ secrets.FIREBASE_APP_ID }}|g' firebase-config.js
          sed -i 's|__MEASUREMENT_ID__|${{ secrets.FIREBASE_MEASUREMENT_ID }}|g' firebase-config.js

          echo "âœ… firebase-config.js generated successfully."

      # æ­¥é©Ÿ 3: è¨­å®š GitHub Pages
      #   ä½¿ç”¨å®˜æ–¹çš„ `configure-pages` action ä¾†è¨­å®š Pages ç’°å¢ƒã€‚
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      # æ­¥é©Ÿ 4: ä¸Šå‚³éƒ¨ç½²ç”¢ç‰© (Artifact)
      #   å°‡æ•´å€‹å°ˆæ¡ˆç›®éŒ„ï¼ˆç¾åœ¨å·²åŒ…å«ç”Ÿæˆå¥½çš„ `firebase-config.js`ï¼‰æ‰“åŒ…ä¸¦ä¸Šå‚³ã€‚
      #   `path: '.'` è¡¨ç¤ºä¸Šå‚³ç•¶å‰ç›®éŒ„ä¸‹çš„æ‰€æœ‰æª”æ¡ˆã€‚
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      # æ­¥é©Ÿ 5: éƒ¨ç½²åˆ° GitHub Pages
      #   ä½¿ç”¨å®˜æ–¹çš„ `deploy-pages` action é€²è¡Œéƒ¨ç½²ã€‚
      #   é€™å€‹æ­¥é©Ÿæœƒè‡ªå‹•å–å¾—ä¸Šä¸€æ­¥ä¸Šå‚³çš„ artifact ä¸¦å°‡å…¶éƒ¨ç½²åˆ°ä½ çš„ç¶²ç«™ã€‚
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4