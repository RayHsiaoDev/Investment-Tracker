name: Deploy to GitHub Pages (with Firebase check)

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ å–å‡ºç¨‹å¼ç¢¼
      - name: Checkout
        uses: actions/checkout@v4

      # 2ï¸âƒ£ æ›¿æ› Firebase config placeholder
      - name: Inject Firebase config
        run: |
          sed -i 's|__API_KEY__|${{ secrets.FIREBASE_API_KEY }}|g' ./firebase-config.template.js
          sed -i 's|__AUTH_DOMAIN__|${{ secrets.FIREBASE_AUTH_DOMAIN }}|g' ./firebase-config.template.js
          sed -i 's|__PROJECT_ID__|${{ secrets.FIREBASE_PROJECT_ID }}|g' ./firebase-config.template.js
          sed -i 's|__STORAGE_BUCKET__|${{ secrets.FIREBASE_STORAGE_BUCKET }}|g' ./firebase-config.template.js
          sed -i 's|__SENDER_ID__|${{ secrets.FIREBASE_SENDER_ID }}|g' ./firebase-config.template.js
          sed -i 's|__APP_ID__|${{ secrets.FIREBASE_APP_ID }}|g' ./firebase-config.template.js
          sed -i 's|__MEASUREMENT_ID__|${{ secrets.FIREBASE_MEASUREMENT_ID }}|g' ./firebase-config.template.js

      # 3ï¸âƒ£ æ”¹åæˆæ­£å¼æª”æ¡ˆ
      - name: Rename firebase config
        run: mv ./firebase-config.template.js ./firebase-config.js

      # 4ï¸âƒ£ é©—è­‰æ›¿æ›çµæœï¼ˆlog æœƒè¢« *** é®ç½©ï¼‰
      - name: Verify config injection
        run: |
          echo "ğŸ” Checking firebase-config.js content..."
          if grep -q "__API_KEY__" firebase-config.js; then
            echo "âŒ Secrets injection failed! Placeholder still found."
            exit 1
          fi
          echo "âœ… Secrets replaced successfully."

      # 5ï¸âƒ£ å»ºç«‹ dist ä¸¦è¤‡è£½æª”æ¡ˆ
      - name: Prepare deploy folder
        run: |
          mkdir dist
          cp -v index.html firebase-config.js dist/
          if [ -d "assets" ]; then cp -r assets dist/; fi
          if [ -d "css" ]; then cp -r css dist/; fi
          if [ -d "js" ]; then cp -r js dist/; fi
          echo "âœ… dist folder contents:"
          ls -R dist

      # 6ï¸âƒ£ è‡ªå‹•é©—è­‰ firebase-config.js æ˜¯å¦æˆåŠŸç”Ÿæˆ
      - name: Validate firebase-config.js in dist
        run: |
          if [ ! -f "dist/firebase-config.js" ]; then
            echo "âŒ firebase-config.js not found in dist!"
            exit 1
          fi

          echo "ğŸ” Checking for valid apiKey..."
          if grep -q "__API_KEY__" dist/firebase-config.js; then
            echo "âŒ firebase-config.js still contains placeholders!"
            exit 1
          fi

          echo "âœ… firebase-config.js found and valid."

      # 7ï¸âƒ£ éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          enable_jekyll: false

      # 8ï¸âƒ£ è‡ªå‹•æª¢æŸ¥ç·šä¸Šæª”æ¡ˆæ˜¯å¦èƒ½è¢«è¨ªå•
      - name: Verify file deployed on GitHub Pages
        run: |
          echo "ğŸŒ Checking deployed firebase-config.js on Pages..."
          sleep 20  # ç­‰å¾…éƒ¨ç½²åŒæ­¥
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://rayhsiaodev.github.io/Investment-Tracker/firebase-config.js)

          if [ "$RESPONSE" != "200" ]; then
            echo "âŒ firebase-config.js not reachable on GitHub Pages (HTTP $RESPONSE)"
            exit 1
          fi

          echo "âœ… firebase-config.js successfully deployed to GitHub Pages."
